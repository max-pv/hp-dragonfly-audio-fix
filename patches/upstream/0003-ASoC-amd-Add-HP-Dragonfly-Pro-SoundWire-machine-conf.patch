From: Max <max@fedora>
Date: Sun, 16 Feb 2026 02:00:00 -0800
Subject: [PATCH 3/4] ASoC: amd: Add HP Dragonfly Pro SoundWire machine config

The HP Dragonfly Pro Laptop PC has two RT1316 amplifiers on SoundWire
link 0 (ADR 0x000030025D131601 and 0x000031025D131601). Add:

- RT1316-only endpoint/link configuration to amd-acp63-acpi-match.c
- HP Dragonfly Pro DMI quirk with ASOC_SDW_CODEC_SPKR flag
- ACP 6.0 revision support in acp-sdw-legacy-mach.c

The machine driver API is adapted to match the kernel 6.18.9 headers
(4-arg parse/count functions, subsystem ID pass-through).

Signed-off-by: Max <max@fedora>
---
 sound/soc/amd/acp/amd-acp63-acpi-match.c |  29 +++++
 sound/soc/amd/acp/acp-sdw-legacy-mach.c  | 62 +++++++---
 2 files changed, 74 insertions(+), 17 deletions(-)

--- a/sound/soc/amd/acp/amd-acp63-acpi-match.c	2026-02-15 16:35:21.025703002 -0800
+++ b/sound/soc/amd/acp/amd-acp63-acpi-match.c	2026-02-15 18:02:42.789263703 -0800
@@ -112,6 +112,30 @@
 	{}
 };
 
+static const struct snd_soc_acpi_adr_device rt1316_only_group_adr[] = {
+	{
+		.adr = 0x000030025D131601ull,
+		.num_endpoints = 1,
+		.endpoints = &spk_l_endpoint,
+		.name_prefix = "rt1316-1"
+	},
+	{
+		.adr = 0x000031025D131601ull,
+		.num_endpoints = 1,
+		.endpoints = &spk_r_endpoint,
+		.name_prefix = "rt1316-2"
+	},
+};
+
+static const struct snd_soc_acpi_link_adr acp63_rt1316_only[] = {
+	{
+		.mask = BIT(0),
+		.num_adr = ARRAY_SIZE(rt1316_only_group_adr),
+		.adr_d = rt1316_only_group_adr,
+	},
+	{}
+};
+
 struct snd_soc_acpi_mach snd_soc_acpi_amd_acp63_sof_sdw_machines[] = {
 	{
 		.link_mask = BIT(0) | BIT(1),
@@ -127,6 +151,11 @@
 struct snd_soc_acpi_mach snd_soc_acpi_amd_acp63_sdw_machines[] = {
 	{
 		.link_mask = BIT(0),
+		.links = acp63_rt1316_only,
+		.drv_name = "amd_sdw",
+	},
+	{
+		.link_mask = BIT(0),
 		.links = acp63_rt722_only,
 		.drv_name = "amd_sdw",
 	},
--- a/sound/soc/amd/acp/acp-sdw-legacy-mach.c	2026-02-15 16:35:21.024816482 -0800
+++ b/sound/soc/amd/acp/acp-sdw-legacy-mach.c	2026-02-15 18:36:21.255522218 -0800
@@ -95,6 +95,14 @@
 		},
 		.driver_data = (void *)(ASOC_SDW_CODEC_SPKR),
 	},
+	{
+		.callback = soc_sdw_quirk_cb,
+		.matches = {
+			DMI_MATCH(DMI_SYS_VENDOR, "HP"),
+			DMI_MATCH(DMI_PRODUCT_NAME, "HP Dragonfly Pro Laptop PC"),
+		},
+		.driver_data = (void *)(ASOC_SDW_CODEC_SPKR),
+	},
 	{}
 };
 
@@ -166,6 +174,8 @@
 		}
 
 		switch (amd_ctx->acp_rev) {
+		case 0x60:
+		case 0x6f:
 		case ACP63_PCI_REV:
 			ret = get_acp63_cpu_pin_id(ffs(soc_end->link_mask - 1),
 						   *be_id, &cpu_pin_id, dev);
@@ -278,6 +288,8 @@
 		return -ENOMEM;
 
 	switch (amd_ctx->acp_rev) {
+	case 0x60:
+	case 0x6f:
 	case ACP63_PCI_REV:
 	case ACP70_PCI_REV:
 	case ACP71_PCI_REV:
@@ -326,6 +338,8 @@
 		return -ENOMEM;
 
 	switch (amd_ctx->acp_rev) {
+	case 0x60:
+	case 0x6f:
 	case ACP63_PCI_REV:
 	case ACP70_PCI_REV:
 	case ACP71_PCI_REV:
@@ -358,12 +372,11 @@
 	int sdw_be_num = 0, dmic_num = 0;
 	struct asoc_sdw_mc_private *ctx = snd_soc_card_get_drvdata(card);
 	struct snd_soc_acpi_mach_params *mach_params = &mach->mach_params;
-	struct asoc_sdw_endpoint *soc_ends __free(kfree) = NULL;
-	struct asoc_sdw_dailink *soc_dais __free(kfree) = NULL;
 	struct snd_soc_codec_conf *codec_conf;
 	struct snd_soc_dai_link *dai_links;
 	int num_devs = 0;
 	int num_ends = 0;
+	int num_confs;
 	int num_links;
 	int be_id = 0;
 	int ret;
@@ -374,17 +387,21 @@
 		return ret;
 	}
 
+	num_confs = num_ends;
+
 	/* One per DAI link, worst case is a DAI link for every endpoint */
-	soc_dais = kcalloc(num_ends, sizeof(*soc_dais), GFP_KERNEL);
+	struct asoc_sdw_dailink *soc_dais __free(kfree) =
+		kcalloc(num_ends, sizeof(*soc_dais), GFP_KERNEL);
 	if (!soc_dais)
 		return -ENOMEM;
 
 	/* One per endpoint, ie. each DAI on each codec/amp */
-	soc_ends = kcalloc(num_ends, sizeof(*soc_ends), GFP_KERNEL);
+	struct asoc_sdw_endpoint *soc_ends __free(kfree) =
+		kcalloc(num_ends, sizeof(*soc_ends), GFP_KERNEL);
 	if (!soc_ends)
 		return -ENOMEM;
 
-	ret = asoc_sdw_parse_sdw_endpoints(card, soc_dais, soc_ends, &num_devs);
+	ret = asoc_sdw_parse_sdw_endpoints(card, soc_dais, soc_ends, &num_confs);
 	if (ret < 0)
 		return ret;
 
@@ -396,7 +413,7 @@
 
 	dev_dbg(dev, "sdw %d, dmic %d", sdw_be_num, dmic_num);
 
-	codec_conf = devm_kcalloc(dev, num_devs, sizeof(*codec_conf), GFP_KERNEL);
+	codec_conf = devm_kcalloc(dev, num_confs, sizeof(*codec_conf), GFP_KERNEL);
 	if (!codec_conf)
 		return -ENOMEM;
 
@@ -407,7 +424,7 @@
 		return -ENOMEM;
 
 	card->codec_conf = codec_conf;
-	card->num_configs = num_devs;
+	card->num_configs = num_confs;
 	card->dai_link = dai_links;
 	card->num_links = num_links;
 
@@ -463,6 +480,10 @@
 	card->late_probe = asoc_sdw_card_late_probe;
 
 	snd_soc_card_set_drvdata(card, ctx);
+	if (mach->mach_params.subsystem_id_set)
+		snd_soc_card_set_pci_ssid(card,
+					  mach->mach_params.subsystem_vendor,
+					  mach->mach_params.subsystem_device);
 
 	dmi_check_system(soc_sdw_quirk_table);
 
-- 
2.48.1
